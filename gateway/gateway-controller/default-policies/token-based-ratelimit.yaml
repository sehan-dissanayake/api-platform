name: token-based-ratelimit
version: v0.3.0
description: |
  Enforces token-based rate limits for LLM traffic by resolving token extraction
  paths from provider templates and delegating enforcement to the
  advanced-ratelimit engine.

parameters:
  type: object
  additionalProperties: false
  properties:
    promptTokenLimits:
      type: array
      x-wso2-policy-advanced-param: false
      description: Specifies rate limits for prompt (input) tokens.
      default: []
      items:
        type: object
        x-wso2-policy-advanced-param: false
        required: ["count", "duration"]
        properties:
          count:
            type: integer
            x-wso2-policy-advanced-param: false
            description: Specifies the maximum number of tokens allowed in the
              configured duration.
            minimum: 1
          duration:
            type: string
            x-wso2-policy-advanced-param: false
            description: Specifies the duration window for the limit, for
              example "1m", "1h", or "24h".
            pattern: "^[-+]?(([0-9]+(\\.[0-9]*)?|\\.[0-9]+)(ns|us|µs|ms|s|m|h))+$"
    completionTokenLimits:
      type: array
      x-wso2-policy-advanced-param: false
      description: Specifies rate limits for completion (output) tokens.
      default: []
      items:
        type: object
        x-wso2-policy-advanced-param: false
        required: ["count", "duration"]
        properties:
          count:
            type: integer
            x-wso2-policy-advanced-param: false
            description: Specifies the maximum number of tokens allowed in the
              configured duration.
            minimum: 1
          duration:
            type: string
            x-wso2-policy-advanced-param: false
            description: Specifies the duration window for the limit, for
              example "1m", "1h", or "24h".
            pattern: "^[-+]?(([0-9]+(\\.[0-9]*)?|\\.[0-9]+)(ns|us|µs|ms|s|m|h))+$"
    totalTokenLimits:
      type: array
      x-wso2-policy-advanced-param: false
      description: Specifies rate limits for total tokens (prompt + completion).
      default: []
      items:
        type: object
        x-wso2-policy-advanced-param: false
        required: ["count", "duration"]
        properties:
          count:
            type: integer
            x-wso2-policy-advanced-param: false
            description: Specifies the maximum number of tokens allowed in the
              configured duration.
            minimum: 1
          duration:
            type: string
            x-wso2-policy-advanced-param: false
            description: Specifies the duration window for the limit, for
              example "1m", "1h", or "24h".
            pattern: "^[-+]?(([0-9]+(\\.[0-9]*)?|\\.[0-9]+)(ns|us|µs|ms|s|m|h))+$"

systemParameters:
  type: object
  additionalProperties: false
  properties:
    algorithm:
      type: string
      description: |
        Rate limiting algorithm to use:
        - gcra: Generic Cell Rate Algorithm (default).
        - fixed-window: Simple fixed time window counter.
      enum: ["gcra", "fixed-window"]
      default: "gcra"
      "wso2/defaultValue": "${config.policy_configurations.ratelimit_v0.algorithm}"

    backend:
      type: string
      description: |
        Rate limit storage backend. 'memory' or 'redis'.
      enum: ["memory", "redis"]
      default: "memory"
      "wso2/defaultValue": "${config.policy_configurations.ratelimit_v0.backend}"

    redis:
      type: object
      description: Redis configuration (only used when backend=redis)
      additionalProperties: false
      properties:
        host:
          type: string
          default: "localhost"
          "wso2/defaultValue": "${config.policy_configurations.ratelimit_v0.redis.host}"
        port:
          type: integer
          default: 6379
          "wso2/defaultValue": "${config.policy_configurations.ratelimit_v0.redis.port}"
        password:
          type: string
          "wso2/defaultValue": "${config.policy_configurations.ratelimit_v0.redis.password}"
        username:
          type: string
          "wso2/defaultValue": "${config.policy_configurations.ratelimit_v0.redis.username}"
        db:
          type: integer
          default: 0
          "wso2/defaultValue": "${config.policy_configurations.ratelimit_v0.redis.db}"
        keyPrefix:
          type: string
          default: "ratelimit:v1:"
          "wso2/defaultValue": "${config.policy_configurations.ratelimit_v0.redis.keyprefix}"
        failureMode:
          type: string
          enum: ["open", "closed"]
          default: "open"
          "wso2/defaultValue": "${config.policy_configurations.ratelimit_v0.redis.failuremode}"
        connectionTimeout:
          type: string
          default: "5s"
          "wso2/defaultValue": "${config.policy_configurations.ratelimit_v0.redis.connectiontimeout}"
        readTimeout:
          type: string
          default: "3s"
          "wso2/defaultValue": "${config.policy_configurations.ratelimit_v0.redis.readtimeout}"
        writeTimeout:
          type: string
          default: "3s"
          "wso2/defaultValue": "${config.policy_configurations.ratelimit_v0.redis.writetimeout}"

    memory:
      type: object
      description: In-memory storage configuration (only used when backend=memory)
      additionalProperties: false
      properties:
        maxEntries:
          type: integer
          default: 10000
          "wso2/defaultValue": "${config.policy_configurations.ratelimit_v0.memory.maxentries}"
        cleanupInterval:
          type: string
          default: "5m"
          "wso2/defaultValue": "${config.policy_configurations.ratelimit_v0.memory.cleanupinterval}"
