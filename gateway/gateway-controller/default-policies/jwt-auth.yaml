name: jwt-auth
version: v0.3.0
description: |
  Validates JWT access tokens in API requests using configured JWKS providers.
  Verifies signature and claims such as expiry, issuer, audience, scopes, and
  required claims.

parameters:
  type: object
  additionalProperties: false
  properties:
    issuers:
      type: array
      x-wso2-policy-advanced-param: true
      description: >-
        Specifies issuer names for token validation by referencing entries in
        `system.keyManagers`. If omitted, runtime matches by token `iss` or
        tries all configured providers.
      default: []
      items:
        type: string

    audiences:
      type: array
      x-wso2-policy-advanced-param: true
      description: Specifies accepted audience values. Token validation succeeds only when at least one configured audience is present.
      default: []
      items:
        type: string

    requiredScopes:
      type: array
      x-wso2-policy-advanced-param: true
      description: Specifies scopes that must exist in the token from `scope` (space-delimited) or `scp` (array) claims.
      default: []
      items:
        type: string

    requiredClaims:
      type: object
      x-wso2-policy-advanced-param: true
      description: Specifies required claim-value pairs as `claimName -> expectedValue`.
      default: {}
      additionalProperties:
        type: string

    claimMappings:
      type: object
      x-wso2-policy-advanced-param: true
      description: Specifies claim-to-output mappings as `claimName -> headerOrContextKey` for downstream use.
      default: {}
      additionalProperties:
        type: string

    authHeaderPrefix:
      type: string
      x-wso2-policy-advanced-param: true
      description: Specifies a route-level authorization scheme prefix (for example, "Bearer" or "JWT") that overrides `system.authHeaderScheme`.
      default: Bearer

    userIdClaim:
      type: string
      x-wso2-policy-advanced-param: true
      description: >-
        Specifies the claim name used to extract the user ID for analytics.
        Defaults to "sub" when omitted.
      default: sub

systemParameters:          
  type: object
  additionalProperties: false
  properties:
    keyManagers:
      type: array
      description: >-
        List of key manager definitions. Each entry must include a unique `name` 
        and either `jwks` (for remote JWKS or local certificates) configuration.
      items:
        type: object
        additionalProperties: false
        required: ["name"]
        properties:
          name:
            type: string
            description: Unique name for this key manager/provider (used in `user.issuers`).
          issuer:
            type: string
            description: Optional issuer (iss) value associated with keys from this provider.
          jwks:
            type: object
            description: JWKS configuration supporting both remote endpoints and local certificates. Either 'remote' or 'local' must be specified, but not both.
            additionalProperties: false
            oneOf:
              - required: ["remote"]
                not:
                  required: ["local"]
              - required: ["local"]
                not:
                  required: ["remote"]
            properties:
              remote:
                type: object
                description: Remote JWKS endpoint configuration. The 'uri' field is required.
                additionalProperties: false
                required: ["uri"]
                properties:
                  uri:
                    type: string
                    format: uri
                    description: JWKS endpoint URL (e.g., https://idp.example/.well-known/jwks.json).
                  certificatePath:
                    type: string
                    description: Optional path to CA certificate file for validating self-signed JWKS endpoints (e.g., /etc/certs/ca.pem).
                  skipTlsVerify:
                    type: boolean
                    default: false
                    description: If true, skip TLS certificate verification for the JWKS endpoint. Use with caution, only for testing or trusted internal endpoints.
              local:
                type: object
                description: Local certificate configuration for signature verification. Either 'inline' or 'certificatePath' must be provided, but not both.
                additionalProperties: false
                oneOf:
                  - required: ["inline"]
                    not:
                      required: ["certificatePath"]
                  - required: ["certificatePath"]
                    not:
                      required: ["inline"]
                properties:
                  inline:
                    type: string
                    description: Inline PEM-encoded certificate or public key for signature verification.
                  certificatePath:
                    type: string
                    description: Path to certificate or public key file (e.g., /etc/certs/public.pem).
      "wso2/defaultValue": "${config.policy_configurations.jwtauth_v0.keymanagers}"

    jwksCacheTtl:
      type: string
      description: Duration string for JWKS caching (e.g., "5m"). If omitted a default is used.
      default: "5m"
      "wso2/defaultValue": "${config.policy_configurations.jwtauth_v0.jwkscachettl}"

    jwksFetchTimeout:
      type: string
      description: Timeout for HTTP fetch of JWKS, e.g., "5s".
      default: "5s"
      "wso2/defaultValue": "${config.policy_configurations.jwtauth_v0.jwksfetchtimeout}"

    jwksFetchRetryCount:
      type: integer
      description: Number of retries for JWKS fetch on transient failures.
      default: 3
      "wso2/defaultValue": "${config.policy_configurations.jwtauth_v0.jwksfetchretrycount}"

    jwksFetchRetryInterval:
      type: string
      description: Interval between JWKS fetch retries, e.g., "2s".
      default: "2s"
      "wso2/defaultValue": "${config.policy_configurations.jwtauth_v0.jwksfetchretryinterval}"

    allowedAlgorithms:
      type: array
      description: Allowed JWT signing algorithms (e.g., ["RS256","ES256"]).
      items:
        type: string
      default: ["RS256", "ES256"]
      "wso2/defaultValue": "${config.policy_configurations.jwtauth_v0.allowedalgorithms}"

    leeway:
      type: string
      description: Clock skew allowance for exp/nbf checks, e.g., "30s".
      default: "30s"
      "wso2/defaultValue": "${config.policy_configurations.jwtauth_v0.leeway}"

    authHeaderScheme:
      type: string
      description: Expected scheme prefix in the authorization header (e.g., "Bearer"). If set, runtime enforces the scheme; if omitted, runtime may accept raw header values or strip known schemes.
      default: Bearer
      "wso2/defaultValue": "${config.policy_configurations.jwtauth_v0.authheaderscheme}"

    headerName:
      type: string
      description: Header name to extract token from (default "Authorization").
      default: Authorization
      "wso2/defaultValue": "${config.policy_configurations.jwtauth_v0.headername}"

    onFailureStatusCode:
      type: integer
      description: HTTP status code to return on authentication failure (401 for Unauthorized, 403 for Forbidden).
      default: 401
      "wso2/defaultValue": "${config.policy_configurations.jwtauth_v0.onfailurestatuscode}"

    errorMessageFormat:
      type: string
      description: Format of error response on JWT validation failure. Supported values are "json" (structured error), "plain" (plain text), or "minimal" (minimal response).
      default: json
      "wso2/defaultValue": "${config.policy_configurations.jwtauth_v0.errormessageformat}"
    
    errorMessage:
      type: string
      description: Custom error message to include in the response body on authentication failure.
      default: "Authentication failed"
      "wso2/defaultValue": "${config.policy_configurations.jwtauth_v0.errormessage}"

    validateIssuer:
      type: boolean
      description: Whether to validate the token's issuer claim against configured key managers.
      default: true
      "wso2/defaultValue": "${config.policy_configurations.jwtauth_v0.validateissuer}"

  required: ["keyManagers"]
