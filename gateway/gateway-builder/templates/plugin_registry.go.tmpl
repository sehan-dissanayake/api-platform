/*
 * Copyright (c) 2025, WSO2 LLC. (https://wso2.com).
 *
 * WSO2 LLC. licenses this file to you under the Apache License,
 * Version 2.0 (the "License"); you may not use this file except
 * in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */

// Code generated by Gateway Builder. DO NOT EDIT.
package main

import (
	"context"
	"log/slog"
	"os"

	"github.com/wso2/api-platform/gateway/gateway-runtime/policy-engine/internal/registry"
	policy "github.com/wso2/api-platform/sdk/gateway/policy/v1alpha"
{{- if .HasPythonPolicies }}
	"github.com/wso2/api-platform/gateway/gateway-runtime/policy-engine/internal/pythonbridge"
{{- end }}
{{- range .GoPolicies }}
	{{ .ImportAlias }} "{{ .ImportPath }}"
{{- end }}
)

func init() {
	// Set up text logger early so init() logs match main() logs
	slog.SetDefault(slog.New(slog.NewTextHandler(os.Stdout, &slog.HandlerOptions{Level: slog.LevelInfo})))
	
	ctx := context.Background()
	slog.InfoContext(ctx, "Registering policies from Builder compilation")

	// Register Go policies
	{{- range .GoPolicies }}
	// Register {{ .Name }} {{ .Version }}
	policyDef_{{ .ImportAlias }} := &policy.PolicyDefinition{
		Name:           "{{ .Name }}",
		Version:        "{{ .Version }}",
		SystemParameters: {{ if .SystemParameters }}map[string]interface{}{
			{{- range $key, $value := .SystemParameters }}
			"{{ $key }}": {{ printf "%#v" $value }},
			{{- end }}
		}{{ else }}nil{{ end }},
	}
	if err := registry.GetRegistry().Register(policyDef_{{ .ImportAlias }}, {{ .ImportAlias }}.GetPolicy); err != nil {
		slog.ErrorContext(ctx, "Failed to register policy {{ .Name }} version {{ .Version }}", "error", err)
	} else {
		slog.InfoContext(ctx, "Registered policy {{ .Name }} version {{ .Version }}")
	}
	{{- end }}

	// Register Python policies via PythonBridge
	{{- range .PythonPolicies }}
	// Register {{ .Name }} {{ .Version }} (Python)
	policyDef_{{ .ImportAlias }} := &policy.PolicyDefinition{
		Name:           "{{ .Name }}",
		Version:        "{{ .Version }}",
		SystemParameters: {{ if .SystemParameters }}map[string]interface{}{
			{{- range $key, $value := .SystemParameters }}
			"{{ $key }}": {{ printf "%#v" $value }},
			{{- end }}
		}{{ else }}nil{{ end }},
	}
	bridgeFactory_{{ .ImportAlias }} := &pythonbridge.BridgeFactory{
		StreamManager: pythonbridge.GetStreamManager(),
		PolicyName:    "{{ .Name }}",
		PolicyVersion: "{{ .Version }}",
		Mode: policy.ProcessingMode{
			RequestHeaderMode:  {{ headerModeConst .ProcessingMode.RequestHeaderMode }},
			RequestBodyMode:    {{ bodyModeConst .ProcessingMode.RequestBodyMode }},
			ResponseHeaderMode: {{ headerModeConst .ProcessingMode.ResponseHeaderMode }},
			ResponseBodyMode:   {{ bodyModeConst .ProcessingMode.ResponseBodyMode }},
		},
	}
	if err := registry.GetRegistry().Register(policyDef_{{ .ImportAlias }}, bridgeFactory_{{ .ImportAlias }}.GetPolicy); err != nil {
		slog.ErrorContext(ctx, "Failed to register Python policy {{ .Name }} version {{ .Version }}", "error", err)
	} else {
		slog.InfoContext(ctx, "Registered Python policy {{ .Name }} version {{ .Version }}")
	}
	{{- end }}
}
