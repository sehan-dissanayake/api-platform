{{- $annotations := merge (deepCopy (default (dict) .Values.commonAnnotations)) (default (dict) .Values.gateway.configMap.annotations) -}}
{{- $gc := .Values.gateway.config.controller -}}
{{- $router := .Values.gateway.config.router -}}
{{- $pe := .Values.gateway.config.policy_engine -}}
{{- $controllerHost := printf "%s-controller" (include "gateway-operator.fullname" .) -}}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "gateway-operator.fullname" . }}-config
  labels:
    {{- include "gateway-operator.labels" . | nindent 4 }}
    {{- with .Values.gateway.configMap.labels }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
  {{- if $annotations }}
  annotations:
    {{- toYaml $annotations | nindent 4 }}
  {{- end }}
data:
  config.toml: |
    [controller.server]
    api_port = {{ $gc.server.api_port }}
    xds_port = {{ $gc.server.xds_port }}
    shutdown_timeout = {{ $gc.server.shutdown_timeout | quote }}
    gateway_id = {{ $gc.server.gateway_id | quote }}

    [controller.policy_server]
    port = {{ $gc.policy_server.port }}

    [controller.policy_server.tls]
    enabled = {{ $gc.policy_server.tls.enabled }}
    cert_file = {{ $gc.policy_server.tls.cert_file | quote }}
    key_file = {{ $gc.policy_server.tls.key_file | quote }}

    [controller.storage]
    type = {{ $gc.storage.type | quote }}

    [controller.storage.sqlite]
    path = {{ $gc.storage.sqlite.path | quote }}

    [controller.policies]
    definitions_path = {{ $gc.policies.definitions_path | quote }}

    [router]
    gateway_host = {{ $router.gateway_host | quote }}
    listener_port = {{ $router.listener_port }}
    https_enabled = {{ $router.https_enabled }}
    https_port = {{ $router.https_port }}
    tracing_service_name = {{ $router.tracing_service_name | default "" | quote }}

    [router.access_logs]
    enabled = {{ $router.access_logs.enabled }}
    format = {{ $router.access_logs.format | quote }}
    {{- if eq $router.access_logs.format "json" }}
    json_fields = { {{- $first := true }}{{- range $key, $value := $router.access_logs.json_fields }}{{- if not $first }}, {{ end }}{{- $first = false }}{{ $key }} = {{ $value | quote }}{{- end }} }
    {{- end }}
    {{- if eq $router.access_logs.format "text" }}
    text_format = {{ $router.access_logs.text_format | quote }}
    {{- end }}

    [router.downstream_tls]
    cert_path = {{ $router.downstream_tls.cert_path | quote }}
    key_path = {{ $router.downstream_tls.key_path | quote }}
    minimum_protocol_version = {{ $router.downstream_tls.minimum_protocol_version | quote }}
    maximum_protocol_version = {{ $router.downstream_tls.maximum_protocol_version | quote }}
    ciphers = {{ $router.downstream_tls.ciphers | quote }}

    [router.upstream.tls]
    minimum_protocol_version = {{ $router.upstream.tls.minimum_protocol_version | quote }}
    maximum_protocol_version = {{ $router.upstream.tls.maximum_protocol_version | quote }}
    ciphers = {{ $router.upstream.tls.ciphers | quote }}
    trusted_cert_path = {{ $router.upstream.tls.trusted_cert_path | quote }}
    custom_certs_path = {{ $router.upstream.tls.custom_certs_path | quote }}
    verify_host_name = {{ $router.upstream.tls.verify_host_name }}
    disable_ssl_verification = {{ $router.upstream.tls.disable_ssl_verification }}

    [router.upstream.timeouts]
    route_timeout_ms = {{ $router.upstream.timeouts.route_timeout_ms }}
    route_idle_timeout_ms = {{ $router.upstream.timeouts.route_idle_timeout_ms }}
    connect_timeout_ms = {{ $router.upstream.timeouts.connect_timeout_ms }}

    [router.policy_engine]
    mode = {{ $router.policy_engine.mode | quote }}
    host = {{ $router.policy_engine.host | default "" | quote }}
    port = {{ $router.policy_engine.port | default 9001 }}
    timeout_ms = {{ $router.policy_engine.timeout_ms }}
    failure_mode_allow = {{ $router.policy_engine.failure_mode_allow }}
    route_cache_action = {{ $router.policy_engine.route_cache_action | quote }}
    allow_mode_override = {{ $router.policy_engine.allow_mode_override }}
    message_timeout_ms = {{ $router.policy_engine.message_timeout_ms }}

    {{- if $router.policy_engine.tls }}
    [router.policy_engine.tls]
    enabled = {{ $router.policy_engine.tls.enabled }}
    {{- if $router.policy_engine.tls.enabled }}
    cert_path = {{ $router.policy_engine.tls.cert_path | quote }}
    key_path = {{ $router.policy_engine.tls.key_path | quote }}
    ca_path = {{ $router.policy_engine.tls.ca_path | quote }}
    server_name = {{ $router.policy_engine.tls.server_name | quote }}
    skip_verify = {{ $router.policy_engine.tls.skip_verify }}
    {{- end }}
    {{- end }}

    {{- if $gc.auth }}
    {{- if $gc.auth.basic }}
    [controller.auth.basic]
    enabled = {{ $gc.auth.basic.enabled }}
    {{- if $gc.auth.basic.users }}
    {{- range $gc.auth.basic.users }}
    [[controller.auth.basic.users]]
    username = {{ .username | quote }}
    password = {{ .password | quote }}
    password_hashed = {{ .password_hashed | default false }}
    roles = [{{- range $i, $role := .roles }}{{- if gt $i 0 }}, {{ end }}{{ $role | quote }}{{- end }}]
    {{- end }}
    {{- end }}
    {{- end }}
    {{- if $gc.auth.idp }}
    [controller.auth.idp]
    enabled = {{ $gc.auth.idp.enabled }}
    jwks_url = {{ $gc.auth.idp.jwks_url | quote }}
    issuer = {{ $gc.auth.idp.issuer | quote }}
    roles_claim = {{ $gc.auth.idp.roles_claim | quote }}
    {{- if $gc.auth.idp.role_mapping }}
    [controller.auth.idp.role_mapping]
    {{- range $key, $value := $gc.auth.idp.role_mapping }}
    {{ $key }} = {{ $value | quote }}
    {{- end }}
    {{- end }}
    {{- end }}
    {{- end }}

    [controller.logging]
    level = {{ $gc.logging.level | quote }}
    format = {{ $gc.logging.format | quote }}

    [policy_engine.server]
    extproc_port = {{ $pe.server.extproc_port }}

    [policy_engine.admin]
    enabled = {{ $pe.admin.enabled }}
    port = {{ $pe.admin.port }}
    allowed_ips = [{{- range $i, $ip := $pe.admin.allowed_ips }}{{- if gt $i 0 }}, {{ end }}{{ $ip | quote }}{{- end }}]

    [policy_engine.config_mode]
    mode = {{ $pe.config_mode.mode | quote }}

    [policy_engine.xds]
    # server_address is set via -xds-server flag (injected by gateway-runtime entrypoint)
    connect_timeout = {{ $pe.xds.connect_timeout | quote }}
    request_timeout = {{ $pe.xds.request_timeout | quote }}
    initial_reconnect_delay = {{ $pe.xds.initial_reconnect_delay | quote }}
    max_reconnect_delay = {{ $pe.xds.max_reconnect_delay | quote }}

    [policy_engine.xds.tls]
    enabled = {{ $pe.xds.tls.enabled }}

    [policy_engine.file_config]
    path = {{ $pe.file_config.path | quote }}

    [policy_engine.logging]
    level = {{ $pe.logging.level | quote }}
    format = {{ $pe.logging.format | quote }}

    {{- if .Values.gateway.config.analytics }}
    [analytics]
    enabled = {{ .Values.gateway.config.analytics.enabled }}
    {{- if .Values.gateway.config.analytics.publishers }}
    {{- range .Values.gateway.config.analytics.publishers }}
    [[analytics.publishers]]
    type = {{ .type | quote }}
    {{- if .config }}
    [analytics.publishers.config]
    {{- range $key, $value := .config }}
    {{ $key }} = {{ $value | quote }}
    {{- end }}
    {{- end }}
    {{- end }}
    {{- end }}
    {{- if .Values.gateway.config.analytics.grpc_event_server }}
    [analytics.grpc_event_server]
    host = "127.0.0.1"
    buffer_flush_interval = {{ .Values.gateway.config.analytics.grpc_event_server.buffer_flush_interval | quote }}
    buffer_size_bytes = {{ .Values.gateway.config.analytics.grpc_event_server.buffer_size_bytes }}
    grpc_request_timeout = {{ .Values.gateway.config.analytics.grpc_event_server.grpc_request_timeout | quote }}
    server_port = {{ .Values.gateway.config.analytics.grpc_event_server.server_port }}
    shutdown_timeout = {{ .Values.gateway.config.analytics.grpc_event_server.shutdown_timeout | quote }}
    public_key_path = {{ .Values.gateway.config.analytics.grpc_event_server.public_key_path | quote }}
    private_key_path = {{ .Values.gateway.config.analytics.grpc_event_server.private_key_path | quote }}
    als_plain_text = {{ .Values.gateway.config.analytics.grpc_event_server.als_plain_text }}
    max_message_size = {{ .Values.gateway.config.analytics.grpc_event_server.max_message_size }}
    max_header_limit = {{ .Values.gateway.config.analytics.grpc_event_server.max_header_limit }}
    {{- end }}
    {{- end }}

    {{- if .Values.gateway.config.tracing }}
    [tracing]
    enabled = {{ .Values.gateway.config.tracing.enabled }}
    endpoint = {{ .Values.gateway.config.tracing.endpoint | quote }}
    insecure = {{ .Values.gateway.config.tracing.insecure }}
    service_version = {{ .Values.gateway.config.tracing.service_version | quote }}
    batch_timeout = {{ .Values.gateway.config.tracing.batch_timeout | quote }}
    max_export_batch_size = {{ .Values.gateway.config.tracing.max_export_batch_size }}
    sampling_rate = {{ .Values.gateway.config.tracing.sampling_rate }}
    {{- end }}

    {{- if .Values.gateway.config.policy_configurations }}
{{ dict "policy_configurations" .Values.gateway.config.policy_configurations | toToml | indent 4 }}
    {{- end }}

    {{- if .Values.gateway.config_toml }}
{{ .Values.gateway.config_toml | indent 4 }}
    {{- end }}
